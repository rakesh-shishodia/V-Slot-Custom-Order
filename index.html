<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom Cut and Machined Aluminium Extrusion Orders in India</title>
  <meta name="description" content="Order custom-cut V-Slot, C-Beam & T-Slot aluminium extrusions with M5/M6/M8 tapping and counterbores. Free shipping. Next-day dispatch from India.">
  <link rel="stylesheet" href="styles.css">  
  <link rel="stylesheet" href="mobile.css">
  <!-- Include jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Ecwid data loader (our new module) -->
  <script src="ecwid-data.js"></script>
  <!-- re-direct cart clicks to full page -->
  <!-- Include Ecwid script for Cart API (store id: 2442119) -->
  <script src="https://app.ecwid.com/script.js?2442119&data_platform=code&data_date=2025-03-02" charset="utf-8"></script>
  <!-- Include review script to show product review summary-->
  <script defer src="https://app.helpfulcrowd.com/f/koS4zR/widgets/product_summary.js"></script>
  <!-- SimpleLightbox CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplelightbox@2.14.1/dist/simple-lightbox.min.css" />
  <!-- SimpleLightbox JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/simplelightbox@2.14.1/dist/simple-lightbox.jquery.min.js"></script>
  
</head>
<body>

<!-- Tool Header -->
<header class="tool-header">
  <div class="header-left">3DPrintronics</div>
  <h1 class="header-title">
    Custom Cut and Machined Aluminium Extrusion Orders in India
  </h1>
  <div class="header-right">
      <div class="ec-cart-widget"></div>
  </div>
</header>

<!-- Mobile-only extrusion dropdown -->
<select id="mobileExtrusionSelect" class="show-mobile hide-desktop">
  <option value="">Select extrusion</option>
</select>

<!-- Filter Controls and Product Boxes Side-by-Side -->
<div class="filter-product-container">
  <!-- Filter Controls -->
  <div class="filter-panel">
    <h2 class="filter-title">Filter</h2>
    <div id="filterControls">
      <div class="filter-group" id="typeFilters"><strong>Type:</strong></div>
      <div class="filter-group" id="seriesFilters"><strong>Series:</strong></div>
      <div class="filter-group" id="colorFilters"><strong>Colour:</strong></div>
      <button type="button" id="clearFiltersBtn">Clear Filters</button>
    </div> <!-- /#filterControls -->
  </div> <!-- /.filter-panel -->
  <!-- Extrusion Selector -->
  <div class="selector-panel">
    <h2 class="selector-title">Select Extrusion and Enter Details in Table Below</h2>
  <div class="extrusion-selector-wrapper">
    <div class="extrusion-selector" id="extrusionSelector">
      <!-- Extrusion boxes will be dynamically populated from extrusions.json -->
    </div>
  </div>
  </div>
</div> <!-- /.filter-product-container -->
<div class="flex-container">
  <div class="details-panel panel">
    <div class="image-grid">
      <div class="image-cell">
        <a href="" class="detail-thumb-link">
          <img src="" alt="Thumbnail" class="detail-thumb" />
        </a>
        <span class="zoom-icon">üîç</span>
      </div>
      <div class="image-cell">
        <!-- Top-right image placeholder; will be dynamically set -->
        <a href="">
          <img src="" alt="Secondary image" />
        </a>
        <span class="zoom-icon">üîç</span>
      </div>
      <div class="image-cell">
        <a href="" class="detail-image-link">
          <img src="" alt="" />
        </a>
        <span class="zoom-icon">üîç</span>
      </div>
      <div class="image-cell">
        <a href="" class="detail-image-link">
          <img src="" alt="" />
        </a>
        <span class="zoom-icon">üîç</span>
      </div>
    </div>
    <div class="video-grid" id="videoGrid">
      <!-- Video iframes will be inserted here -->
    </div>
    <div class="description-container">
      <!-- Product description (supports HTML formatting) -->
    </div>
  </div>
  <!-- Mobile card-style ordering interface -->
  <div class="mobile-order-cards show-mobile hide-desktop">
    <!-- Piece Count Control -->
    <div class="pieces-control">
      <label for="pieceCountInput">Enter number of pieces you want to order</label>
      <input type="number" id="pieceCountInput" min="1" value="1" />
      <button type="button" id="updatePiecesBtn">Update</button>
    </div>

    <!-- Order Cards Container -->
    <div class="order-cards-container">
      <table class="order-card table-card" data-index="1">
        <thead>
          <tr>
            <th colspan="2">Enter Details of Pc No. 1</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><label for="card1-length">Length (mm)</label></td>
            <td><input type="number" id="card1-length" class="card-cut-length" min="100" max="3000" placeholder="e.g. 1000" /></td>
          </tr>
          <tr>
            <td><label for="card1-tap">M5 Tap<br>(0 = none, 1 = one side, <br>2 = both sides)</label></td>
            <td><input type="number" id="card1-tap" class="card-tap-side" placeholder="0‚Äì2" min="0" max="2" step="1" required /></td>
          </tr>
          <tr>
            <td><label for="card1-cb">Counter Bore Holes</label></td>
            <td><input type="number" id="card1-cb" class="card-cb-holes" min="0" max="20" value="0" /></td>
          </tr>
          <tr>
            <td><label for="card1-pcs">No. of Pcs</label></td>
            <td><input type="number" id="card1-pcs" class="card-num-pcs" min="1" placeholder="e.g. 2" /></td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="2">
              <button type="button" class="remove-card-btn">Remove this piece</button>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
    <!-- Mobile Aggregate Card -->
    <div class="mobile-layout-aggregate-card show-mobile hide-desktop">
      <table class="aggregate-card">
        <thead>
          <tr>
            <th colspan="2">Order Summary</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Total Ordered Length</td>
            <td id="mobileTotalOrdered">0</td>
          </tr>
          <tr>
            <td>Rounded Length</td>
            <td id="mobileRoundedLength">0</td>
          </tr>
          <tr>
            <td>Cost of Extrusion</td>
            <td id="mobileCostExtrusions">0.00</td>
          </tr>
          <tr>
            <td>Total M5 Taps</td>
            <td id="mobileTotalM5Count">0</td>
          </tr>
          <tr>
            <td>Cost of M5 Taps</td>
            <td id="mobileTotalM5Cost">0.00</td>
          </tr>
          <tr>
            <td>Total CB Holes</td>
            <td id="mobileTotalCBCount">0</td>
          </tr>
          <tr>
            <td>Cost of CB Holes</td>
            <td id="mobileTotalCBCost">0.00</td>
          </tr>
          <tr>
            <td>Subtotal</td>
            <td id="mobileSubtotal">0.00</td>
          </tr>
          <tr>
            <td>GST (18%)</td>
            <td id="mobileGST">0.00</td>
          </tr>
          <tr>
            <td><strong>Grand Total</strong></td>
            <td id="mobileTotal">0.00</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="order-panel">

    <!-- Custom Ordering Table -->
    <div id="formError" class="error-banner" style="display:none;"></div>
    <form id="extrusionForm">
      <table id="orderTable">
        <thead>
          <tr>
            <th>
              Enter Cut Length in mm<br>
              (min 100mm, max 3000mm)
            </th>
            <th>
              M5 Tap <br> (0 = none, 1 = one side, 2 = both sides)
              <span class="info-icon" data-info="For V Slot - M5x15mm, For 3030 T Slot - M8X15mm, For others please check drawing">
                <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="8" cy="8" r="7" fill="#006064"/>
                  <text x="8" y="12" font-size="10" text-anchor="middle" fill="#fff">i</text>
                </svg>
              </span>
            </th>
            <th>
              Counter Bore
              <span class="info-icon" data-info="For V Slot: ID 5mm, OD 10mm; For 3030: ID 8mm, OD 15mm; For others, check drawing">
                <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="8" cy="8" r="7" fill="#006064"/>
                  <text x="8" y="12" font-size="10" text-anchor="middle" fill="#fff">i</text>
                </svg>
              </span>
            </th>
            <th>No. of Pcs</th>
            <th>Row Total <br>
              Length</th>
            <th>Reset or <br>
              Delete Row</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- 6 rows will be inserted dynamically -->
        </tbody>
      </table>
      
      <button type="button" id="addRowBtn">Add More Rows</button>
      <button type="button" id="resetAllBtn">Reset All</button>
      
      <!-- Aggregate Totals Table -->
      <table class="totals-table">
        <thead>
          <tr>
            <th>Total Length <br> Ordered</th>
            <th>Rounded Off Length <br> (to nearest 500mm)</th>
            <th>Cost of Rounded Off Length</th>
            <!-- <th>Discount (2.5-4m:5%, 4.5-8m:10%, Above 8.5m:15%)</th> -->
            <th>Total <br>M5 Taps</th>
            <th>Cost M5 Taps <br>(‚Çπ30/hole)</th>
            <th>Total <br>CB Holes</th>
            <th>Cost CB Holes<br>(‚Çπ70/hole)</th>
            <th>Subtotal</th>
            <th>GST<br>@18%</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="totalOrdered">0</td>
            <td id="roundedLength">0</td>
            <td id="costExtrusions">0</td>
            <!-- <td id="discount">0</td> -->
            <td id="totalM5Count">0</td>
            <td id="totalM5Cost">0</td>
            <td id="totalCBCount">0</td>
            <td id="totalCBCost">0</td>
            <td id="subtotal">0</td>
            <td id="GST">0</td>
            <td id="Total">0</td>
          </tr>
        </tbody>
      </table>
      <!-- Desktop Add to Cart button and waste policy (hide on mobile) -->
      <button type="button" id="addToCartBtn" class="hide-mobile">Add to Cart</button>
      <div class="waste-policy hide-mobile" style="margin: 15px 0; font-size: 14px; color: #333;">
        <p>
          <strong>Billing is rounded up to the nearest 500 mm; any off-cut over 100 mm is shipped to you.</strong><br>
          <strong>Example</strong> ‚Äì You order <strong>2 pcs of 1000 mm</strong> and <strong>1 pc of 1200 mm</strong> (total 3200 mm), so we bill for <strong>3500 mm</strong>. You‚Äôll receive your <strong>2 pcs of 1000 mm</strong>, <strong>1 pc of 1200 mm</strong> plus a <strong>300 mm off-cut</strong>.<br>
          <a href="#" id="readMoreLink" style="text-decoration: underline; cursor: pointer;">[Read More]</a>
        </p>
        <div id="wasteDetails" style="display:none; margin-top:10px; padding-left:10px; border-left: 3px solid #ff9800;">
          <strong>Material &amp; Waste Policy</strong><br><br>
          We cut orders in 500 mm increments to reduce material wastage, keep our prices low and our operations efficient, and <strong>those savings go straight into your final per-metre rate</strong>.<br><br>
          <strong>How it works:</strong><br>
          1. Rounding: Every order is rounded up to the next 500 mm increment and accordingly billed for.<br>
          2. Clean-offs: Rather than discard leftovers, we ship you any piece longer than 100 mm.<br><br>
          <strong>Real-world example:</strong><br>
          ‚Ä¢ You specify: 2 pcs of 1000 mm and 1 pc of 1200 mm (total 3200 mm).<br>
          ‚Ä¢ We round up and bill 3500 mm at your per-metre rate.<br>
          ‚Ä¢ You receive 2 pcs of 1000 mm and 1 pc of 1200 mm plus a 300 mm off-cut which you can use for jigs, fixtures, or future tweaks.<br><br>
          This policy keeps our material costs predictable and our prices competitive‚Äîwhile ensuring you never Total for wasted material.
        </div>
      </div>
    </form>
  </div> <!-- .order-panel -->

  <button type="button" id="addToCartBtnMobile" class="show-mobile hide-desktop">Add to Cart</button>
  <div class="waste-policy show-mobile hide-desktop" style="margin: 15px 0; font-size: 14px; color: #333;">
    <p>
      <strong>Billing is rounded up to the nearest 500 mm; any off-cut over 100 mm is shipped to you.</strong><br>
      <strong>Example</strong> ‚Äì You order <strong>2 pcs of 1000 mm</strong> and <strong>1 pc of 1200 mm</strong> (total 3200 mm), so we bill for <strong>3500 mm</strong>. You‚Äôll receive your <strong>2 pcs of 1000 mm</strong>, <strong>1 pc of 1200 mm</strong> plus a <strong>300 mm off-cut</strong>.<br>
      <a href="#" id="readMoreLink" style="text-decoration: underline; cursor: pointer;">[Read More]</a>
    </p>
    <div id="wasteDetails" style="display:none; margin-top:10px; padding-left:10px; border-left: 3px solid #ff9800;">
      <strong>Material &amp; Waste Policy</strong><br><br>
      We cut orders in 500 mm increments to reduce material wastage, keep our prices low and our operations efficient, and <strong>those savings go straight into your final per-metre rate</strong>.<br><br>
      <strong>How it works:</strong><br>
      1. Rounding: Every order is rounded up to the next 500 mm increment and accordingly billed for.<br>
      2. Clean-offs: Rather than discard leftovers, we ship you any piece longer than 100 mm.<br><br>
      <strong>Real-world example:</strong><br>
      ‚Ä¢ You specify: 2 pcs of 1000 mm and 1 pc of 1200 mm (total 3200 mm).<br>
      ‚Ä¢ We round up and bill 3500 mm at your per-metre rate.<br>
      ‚Ä¢ You receive 2 pcs of 1000 mm and 1 pc of 1200 mm plus a 300 mm off-cut which you can use for jigs, fixtures, or future tweaks.<br><br>
      This policy keeps our material costs predictable and our prices competitive‚Äîwhile ensuring you never Total for wasted material.
    </div>
  </div>
</div> <!-- .flex-container -->

<script>

  let config = {};
  let pendingProductOptions = null;
  // Global variables
  let selectedExtrusion = null;  // Currently selected extrusion object
  const additionalCosts = { m5Tapping: 30, counterBore: 70 };

  // Load configuration from Ecwid instead of extrusions.json
EcwidData.fetchAll()
  .then(data => {
    config.extrusions      = data;
    config.standardLengths = EcwidData.standardLengths;
    // Initialize filter module
    VSlot.filters.init(config.extrusions);
    // Populate selector and update totals
    populateExtrusionBoxes(config.extrusions);
    // Populate mobile dropdown after extrusion boxes
    populateMobileDropdown(config.extrusions);
    // Auto-select first extrusion on page load
    const $firstBox = $('#extrusionSelector .extrusion-box').first();
    if ($firstBox.length) {
      $firstBox.addClass('selected').trigger('click');
    }
    updateTotals();
  })
  .catch(err => console.error('EcwidData.fetchAll() failed:', err));
  // Dynamically build the extrusion selector buttons
  function populateExtrusionBoxes(items) {
    const list = items || config.extrusions;
    const container = $('#extrusionSelector');
    // Clear existing selector boxes
    container.empty();
    // Re-add selector title
    list.forEach(function(item) {
      const pricePerMeter = (item.baseCostPerMm * 1000).toFixed(0);
      const box = $(`
        <div class="extrusion-box" data-id="${item.id}">
          <div class="extrusion-name">${item.name}</div>
          <div class="price-per-meter">‚Çπ${pricePerMeter}/m</div>
           <div class="stock-pill">${ item.inStock ? 'In Stock' : 'Out of Stock' }</div>
        </div>
      `);
      if (!item.inStock) {
      box.find('.stock-pill').addClass('out-of-stock');
      }
      box.on('click', function() {
        $('.extrusion-box').removeClass('selected');
        $(this).addClass('selected');
        selectedExtrusion = item;
        // Disable Add to Cart if the selected extrusion is out of stock
        if (!item.inStock) {
          $('#addToCartBtn').prop('disabled', true);
        }
        // Populate all four detail images from Ecwid data
        const imgs = item.images; 
        const $cells = $('.details-panel .image-grid .image-cell');
        $cells.each(function(idx) {
          const url = imgs[idx] || '';
          const $link = $(this).find('a');
          const $img  = $link.find('img');
          if (url) {
            $link.attr('href', url);
            $img.attr('src', url);
          } else {
            $link.removeAttr('href');
            $img.attr('src', '');
          }
        });
        // Reinitialize SimpleLightbox to include updated anchors
        if (detailLightbox && typeof detailLightbox.destroy === 'function') {
          detailLightbox.destroy();
        }
        detailLightbox = $('.details-panel .image-grid a').simpleLightbox({
          captions: false,
          nav: true,
          close: true,
          docClose: true,
          enableKeyboard: true,
          showCounter: false
        });
        // Insert description HTML from Ecwid data
        $('.description-container').html(item.descriptionHtml);
        // Insert video iframes (up to 4), stacked vertically
        const $videoGrid = $('#videoGrid').empty();
        const videoUrls = (item.videos || []).slice(0, 4);
        videoUrls.forEach(url => {
        const embedUrl = url.replace("watch?v=", "embed/");
        const $iframe = $(`
        <iframe width="100%" height="315" 
            src="${embedUrl}" 
            title="YouTube video player" 
            frameborder="0" allowfullscreen loading="lazy">
        </iframe>
  `);
  $videoGrid.append($iframe);
});
        // Recalculate aggregate totals when extrusion selection changes.
        updateTotals();
        // Also update mobile aggregate totals immediately
        if (typeof updateMobileTotals === 'function') {
          updateMobileTotals();
        }
      });
      container.append(box);
    });
  }

  // Populate the mobile dropdown with extrusion options
  function populateMobileDropdown(items) {
    const $select = $('#mobileExtrusionSelect');
    // Remove all options except the placeholder (value="")
    $select.find('option:not([value=""])').remove();
    (items || []).forEach(function(item) {
      $('<option>')
        .val(item.id)
        .text(item.name + ' (‚Çπ' + (item.baseCostPerMm*1000).toFixed(0) + '/m)')
        .prop('disabled', !item.inStock)
        .appendTo($select);
    });
  }

    
  // Calculate and display a single row‚Äôs total length
  function updateRow($row) {
    const cutLength = parseFloat($row.find('.cut-length').val()) || 0;
    const numPcs = parseFloat($row.find('.num-pcs').val()) || 0;
    const rowTotal = cutLength * numPcs;
    $row.find('.row-total-length').text(rowTotal.toFixed(0));
  }
  
  // Aggregate all rows, perform rounding and cost calculations, and update the totals table
  function updateTotals() {
    let totalOrdered = 0;
    let totalM5Count = 0;
    let totalCBCount = 0;
    $('#tableBody tr').each(function() {
      const rowTotal = parseFloat($(this).find('.row-total-length').text()) || 0;
      totalOrdered += rowTotal;
      const sides = parseInt($(this).find('.tap-side').val(), 10) || 0;
      const pcsValue = parseFloat($(this).find('.num-pcs').val()) || 0;
      const holesPerSide = selectedExtrusion.holesPerSide || 0;
      totalM5Count += sides * holesPerSide * pcsValue;
  
      const cbValue = parseFloat($(this).find('.cb-holes').val()) || 0;
      totalCBCount += cbValue * pcsValue;
    });
    $('#totalOrdered').text(totalOrdered.toFixed(0));
  
    let roundedLength = 0;
    if (totalOrdered > 0 && selectedExtrusion) {
      roundedLength = config.standardLengths.find(len => len >= totalOrdered)
                      || config.standardLengths[config.standardLengths.length - 1];
    }
    console.log("Total Ordered Length:", totalOrdered);
    console.log("Rounded Length Before Selection:", roundedLength);
    console.log("Available Standard Lengths:", config.standardLengths);
    $('#roundedLength').text(roundedLength.toFixed(0));
  
    let costExtrusions = 0;
    if (selectedExtrusion && selectedExtrusion.baseCostPerMm) {
      costExtrusions = roundedLength * selectedExtrusion.baseCostPerMm;
      console.log("Base Cost Per mm:", selectedExtrusion.baseCostPerMm);
      console.log("Calculated Cost:", costExtrusions);
    } else {
      console.log("Error: selectedExtrusion not set or baseCostPerMm missing");
    }
    $('#costExtrusions').text(costExtrusions.toFixed(2));
  
    $('#totalM5Count').text(totalM5Count.toFixed(0));
    $('#totalCBCount').text(totalCBCount.toFixed(0));
  
    const totalM5Cost = totalM5Count * additionalCosts.m5Tapping;
    const totalCBCost = totalCBCount * additionalCosts.counterBore;
    $('#totalM5Cost').text(totalM5Cost.toFixed(2));
    $('#totalCBCost').text(totalCBCost.toFixed(2));
  
    const subtotal = costExtrusions + totalM5Cost + totalCBCost;
    $('#subtotal').text(subtotal.toFixed(2));

    const GST = subtotal * .18;
    $('#GST').text(GST.toFixed(2));

    const Total = subtotal + GST;
    $('#Total').text(Total.toFixed(2));

  
    // Disable Add to Cart if aggregate rounded length is 0.
    if (roundedLength === 0) {
      $('#addToCartBtn').prop('disabled', true);
    } else {
      $('#addToCartBtn').prop('disabled', false);
    }

    // Disable Add to Cart if item is out of stock.
    if (!selectedExtrusion.inStock) {
    $('#addToCartBtn').prop('disabled', true);
    }
  }
  
  // (Removed: Event listener moved to end of script)
  
  // Handle "Add to Cart" button clicks: build options and call Ecwid API
  $('#addToCartBtn, #addToCartBtnMobile').on('click', function() {
    console.log('Add to Cart clicked, selectedExtrusion:', selectedExtrusion);
    // Clear previous errors
    $('#formError').hide();
    $('.cut-length').removeClass('error');
    
    // Validate cut-length inputs
    let invalidCut = false;
    $('.cut-length').each(function() {
      const raw = $(this).val().trim();
      if (raw === '') {
        return; // skip empty fields
      }
      const v = parseFloat(raw);
      if (isNaN(v) || v < 100 || v > 3000) {
        invalidCut = true;
        $(this).addClass('error');
      }
    });
    if (invalidCut) {
      $('#formError')
        .text("Please correct the highlighted cut lengths (100‚Äì3000 mm).")
        .show();
      return;
    }
    if (!selectedExtrusion) {
      alert("Please select an extrusion type.");
      return;
    }
  
    // Build detailed order string from table rows in the format "cutLength-numPcs pc-M5Tap{m5}-CBHole{cb}"
    let orderDetails = [];
    $('#tableBody tr').each(function() {
      const cutLength = $(this).find('.cut-length').val();
      const numPcs = $(this).find('.num-pcs').val();
      // Determine tapped sides from numeric input
      const sides = parseInt($(this).find('.tap-side').val(), 10) || 0;
      const holesPerSide = selectedExtrusion.holesPerSide || 0;
      const m5 = sides * holesPerSide;
      const cb = $(this).find('.cb-holes').val();
      if (cutLength && numPcs) {
        orderDetails.push(`${cutLength}-${numPcs}pc-M5Tap${m5 || 0}-CBHole${cb || 0}`);
      }
    });
    const detailsString = orderDetails.join('; ');
  
    // Retrieve aggregated totals from the totals table.
    const totalM5Count = parseInt($('#totalM5Count').text(), 10) || 0;
    const totalCBCount = parseInt($('#totalCBCount').text(), 10) || 0;
    const roundedLengthValue = parseInt($('#roundedLength').text(), 10) || 0;
  
    // Build the same semicolon-separated Cut Details for Ecwid
    const previewLines = orderDetails.map(detail => {
      const [length, pcsPart, tapPart, cbPart] = detail.split('-');
      const count = parseInt(pcsPart, 10) || 0;
      const pcsLabel = count === 1 ? '1 pc' : `${count} pcs`;
      const tapCount = parseInt(tapPart.replace('M5Tap', ''), 10) || 0;
      const cbCount = parseInt(cbPart.replace('CBHole', ''), 10) || 0;

      const machining = [];
      if (tapCount === 1) machining.push('One Side M5 Tapped');
      else if (tapCount > 1) machining.push('Both Sides M5 Tapped');
      if (cbCount > 0) machining.push(`${cbCount} CB Holes in each`);

      return machining.length > 0
        ? `${pcsLabel} of ${length} mm ‚Äì ${machining.join(', ')}`
        : `${pcsLabel} of ${length} mm`;
    });
    // Assign to pendingProductOptions for Ecwid
    pendingProductOptions = {
      "Length": roundedLengthValue.toString(),
      "M5 Tap Holes": totalM5Count.toString(),
      "Counter Bore Holes": totalCBCount.toString(),
      "Cut Details": previewLines.join('; ')
    };

    // Build human-readable preview lines in desired format
    $('#previewTitle').text(`Your Order for ${selectedExtrusion.name}`);
    $('#previewList').empty();
    let totalPcs = 0;
    orderDetails.forEach(detail => {
      const [length, pcsPart, tapPart, cbPart] = detail.split('-');
      const count = parseInt(pcsPart, 10) || 0;
      const pcsLabel = count === 1 ? '1 pc' : `${count} pcs`;
      const tapCount = parseInt(tapPart.replace('M5Tap', ''), 10) || 0;
      const cbCount = parseInt(cbPart.replace('CBHole', ''), 10) || 0;

      const machining = [];
      if (tapCount === 1) machining.push('One Side M5 Tapped');
      else if (tapCount > 1) machining.push('Both Sides M5 Tapped');
      if (cbCount > 0) machining.push(`${cbCount} CB Holes in each`);

      const line = machining.length > 0
        ? `${pcsLabel} of ${length} mm ‚Äì ${machining.join(', ')}`
        : `${pcsLabel} of ${length} mm`;

      $('#previewList').append(`<li>${line}</li>`);
      totalPcs += count;
    });
    // Check for lengths > 1000mm and show a warning message
    const hasLongExtrusion = orderDetails.some(detail => {
      const [length] = detail.split('-');
      return parseFloat(length) > 1000;
    });
    if (hasLongExtrusion) {
      $('#previewShippingNote').html(
        `<div style="margin-top:10px; padding:10px; background:#fff3cd; border-left:5px solid #ff9800;">
          <strong>Note:</strong> We offer free shipping up to 1000mm length pcs. One or more extrusions are more than 1000mm in length and thus we will have to charge applicable shipping. For your order, please checkout using <strong>'Wire Transfer'</strong> as payment option. We will update shipping costs and then seek your payment through UPI or payment link. You will get an email and call from us for this.
        </div>`
      );
    } else {
      $('#previewShippingNote').empty();
    }
    $('#previewTotal').text(`Total Pcs ‚Äì ${totalPcs}`);
// Show preview modal and halt actual add-to-cart
$('#orderPreviewModal').show();
return;
  
    // Optionally, log the product options before adding to cart.
    console.log('Adding product with options:', pendingProductOptions);
    
    Ecwid.Cart.addProduct({
      id: selectedExtrusion.id,
      quantity: 1,
      options: pendingProductOptions
    },
    function(order) {
      console.log('Add to Cart success callback, order:', order);
      // Populate and show success modal with order details
      document.getElementById('modalDetails').textContent = detailsString;
      document.getElementById('successModal').style.display = 'block';
    },
    function(error) {
      console.error('Add to Cart error callback, error:', error);
    });
  });
</script>
</script>

<!-- Order Preview Modal -->
<div id="orderPreviewModal" class="modal">
  <div class="modal-content">
    <span class="close" id="previewClose" aria-label="Close preview">&times;</span>
    <h2 id="previewTitle">Your Order for </h2>
    <ul id="previewList" style="text-align:left; margin:10px 0;"></ul>
    <div id="previewShippingNote"></div>
    <p id="previewTotal" style="font-weight:bold;"></p>
    <button type="button" id="amendOrderBtn">Amend Order</button>
    <button type="button" id="proceedOrderBtn">Proceed to Add to Cart</button>
  </div>
</div>
<!-- Success Modal -->
<div id="successModal" class="modal">
  <div class="modal-content">
    <span id="modalClose" class="close">&times;</span>
    <h2>Successfully Added to Cart</h2>
    <p id="modalDetails"></p>
  </div>
</div>

<!-- Info-icon modal (singleton!) -->
<div id="infoModal" class="modal">
  <div class="modal-content">
    <span id="infoModalClose" class="close" aria-label="Close info">&times;</span>
    <div id="infoModalText"></div>
  </div>
</div>

<script>
  // Modal behavior: close on click outside or on close button
  // Modal control
  const successModal = document.getElementById('successModal');
  const previewModal = document.getElementById('orderPreviewModal');
  const modalClose = document.getElementById('modalClose');
  modalClose.onclick = () => { successModal.style.display = 'none'; };
  window.onclick = (event) => {
    if (event.target === successModal) {
      successModal.style.display = 'none';
    }
    if (event.target === previewModal) {
      previewModal.style.display = 'none';
    }
  };
  // Preview modal controls
  $('#previewClose').on('click', () => { $('#orderPreviewModal').hide(); });
  $('#amendOrderBtn').on('click', () => { $('#orderPreviewModal').hide(); });
  $('#proceedOrderBtn').on('click', () => {
    console.log('Proceed clicked')
    $('#orderPreviewModal').hide();
    Ecwid.Cart.addProduct({
      id: selectedExtrusion.id,
      quantity: 1,
      options: pendingProductOptions
    }, function(success) {
      console.log('üõí addProduct callback, success:', success);
      if (success) {
        VSlot.table.init();
        updateTotals();
        // Show cut details in the success modal
        const detailsText = pendingProductOptions && pendingProductOptions["Cut Details"]
                          ? pendingProductOptions["Cut Details"]
                          : 'Added to cart successfully.';
        $('#modalDetails').text(detailsText);
        pendingProductOptions = null;
        $('#successModal').show();
      } else {
        console.error('Add to cart failed.');
      }
    });
  });
</script>
  <!-- Code for Inline Info Icon -->
<script>
  (function() {
    const modal = document.getElementById('infoModal');
    const text  = document.getElementById('infoModalText');
    const close = document.getElementById('infoModalClose');

    document.body.addEventListener('click', (e) => {
      const icon = e.target.closest('.info-icon');
      if (!icon) return;
      const msg = icon.dataset.info;
      if (!msg) return;
      text.textContent = msg;
      modal.style.display = 'flex';
    });

    close.addEventListener('click', () => modal.style.display = 'none');
    modal.addEventListener('click', e => {
      if (e.target === modal) modal.style.display = 'none';
    });
  })();
  </script>
</body>
<script>
(function(VSlot, $) {
  // Centralized settings for table module
  const settings = {
    minLen: 100,
    maxLen: 3000,
    initRows: 4
  };
  // Cache jQuery selectors for table, add row, and reset all buttons
  const $tableBody   = $('#tableBody');
  const $addRowBtn   = $('#addRowBtn');
  const $resetAllBtn = $('#resetAllBtn');
  // Utility: debounce to limit frequent calls
  function debounce(fn, delay) {
    let timer;
    return function() {
      const context = this, args = arguments;
      clearTimeout(timer);
      timer = setTimeout(() => fn.apply(context, args), delay);
    };
  }
  // Debounced version of updateTotals to prevent layout thrashing
  const debouncedUpdateTotals = debounce(updateTotals, 100);
  // Table module for cut orders
  VSlot.table = {
    createRow: function() {
      return `
        <tr>
          <td><input type="number" class="cut-length" placeholder="Precisely Cut" min="${settings.minLen}" max="${settings.maxLen}" required /></td>
          <td><input type="number" class="tap-side" placeholder="0,1 or 2" min="0" max="2" step="1" required /></</td>
          <td class="cb-holes-cell">
            <input type="number" class="cb-holes" value="0" min="0" max="20" required />
            <span class="cb-holes-suffix">holes</span>
          </td>
          <td><input type="number" class="num-pcs" placeholder="No. of Pcs" min="1" required /></td>
          <td class="row-total-length">0</td>
          <td>
            <button type="button" class="reset-row-btn">Reset</button>
            <button type="button" class="delete-row-btn">Del</button>
          </td>
        </tr>
      `;
    },
    attachRowListeners: function($row) {
      // Prevent non-numeric input in cut-length and pcs fields, and remove error when pcs ‚â•1
      $row.find('.cut-length, .num-pcs').on('input', function() {
        this.value = this.value.replace(/\D/g, '');
        if ($(this).hasClass('num-pcs')) {
          const v = parseInt(this.value, 10) || 0;
          if (v >= 1) {
            $(this).removeClass('error');
            // Hide the form error banner if no errors remain
            if ($('.cut-length.error, .num-pcs.error').length === 0) {
              $('#formError').hide();
            }
          }
        }
      });
      // Require at least 1 piece when a cut-length is specified
      $row.find('.num-pcs').on('blur', function() {
        const pcsVal = parseInt($(this).val(), 10) || 0;
        const cutVal = parseFloat($row.find('.cut-length').val()) || 0;
        if (cutVal > 0 && pcsVal < 1) {
          $(this).addClass('error');
          $('#formError')
            .text("Please enter at least 1 piece for each specified cut length.")
            .show();
        }
      });
      // Prevent non-numeric input in counter bore holes, reverting to 0 if emptied
      $row.find('.cb-holes').on('input', function() {
        const cleaned = this.value.replace(/\D/g, '');
        this.value = cleaned === '' ? '0' : cleaned;
      });
      $row.find('input, select.tap-side').on('input change', function() {
        // If this is a cut-length field, remove error styling when valid
        if ($(this).hasClass('cut-length')) {
          const raw = $(this).val().trim();
          const v = parseFloat(raw);
          if (!isNaN(v) && v >= settings.minLen && v <= settings.maxLen) {
            $(this).removeClass('error');
          }
          // Hide the form error banner if no more invalid cut-length fields
          if ($('.cut-length.error').length === 0) {
            $('#formError').hide();
          }
        }
        updateRow($row);
        debouncedUpdateTotals();
      });
      $row.find('.reset-row-btn').on('click', function() {
        $row.find('input').val('');
        updateRow($row);
        updateTotals();
      });
      $row.find('.delete-row-btn').on('click', function() {
        $row.remove();
        updateTotals();
      });
      // Clamp tap-side input to 0‚Äì2
      $row.find('.tap-side').on('input', function() {
        let v = parseInt(this.value.replace(/\D/g, ''), 10);
        if (isNaN(v)) v = '';
        else if (v < 0) v = 0;
        else if (v > 2) v = 2;
        this.value = v;
      });
      // Validate tap-side on blur: blank ‚Üí 0, enforce 0‚Äì2 range
      $row.find('.tap-side').on('blur', function() {
        const $f = $(this);
        let v = parseInt($f.val().replace(/\D/g, ''), 10);
        // Treat blank as 0
        if (isNaN(v)) v = 0;
        // If out of range, mark error
        if (v < 0 || v > 2) {
          $f.addClass('error');
          // Remove any existing message
          $f.next('.field-error').remove();
          // Add inline error message
          $('<div class="field-error" style="color:#e53935; font-size:0.9rem; margin-top:0.25rem;">')
            .text('Enter 0, 1 or 2 only')
            .insertAfter($f);
          // Reset to blank so user re-enters
          $f.val('');
        } else {
          // Valid: clear error styling and message, update value
          $f.removeClass('error');
          $f.next('.field-error').remove();
          $f.val(v);
        }
      });
    },
    init: function() {
      // Delegate all row-specific events to table container
      $tableBody
        .on('input change', '.cut-length, .tap-side, .num-pcs', function() {
          // Numeric-only enforcement for cut-length and pcs
          if ($(this).is('.cut-length, .num-pcs')) {
            this.value = this.value.replace(/\D/g, '');
          }
          const $row = $(this).closest('tr');
          // If cut-length, validate range and clear error
          if ($(this).hasClass('cut-length')) {
            const v = parseFloat($(this).val()) || 0;
            if (v >= settings.minLen && v <= settings.maxLen) {
              $(this).removeClass('error');
              if ($('.cut-length.error').length === 0) {
                $('#formError').hide();
              }
            }
          }
          // If this is the pcs field, remove error styling when valid
          if ($(this).hasClass('num-pcs')) {
            const v = parseInt($(this).val(), 10) || 0;
            if (v >= 1) {
              $(this).removeClass('error');
              if ($('.cut-length.error, .num-pcs.error').length === 0) {
                $('#formError').hide();
              }
            }
          }
          updateRow($row);
          debouncedUpdateTotals();
        })
        .on('input', '.cb-holes', function() {
          const cleaned = this.value.replace(/\D/g, '');
          this.value = cleaned === '' ? '0' : cleaned;
        })
        .on('blur', '.num-pcs', function() {
          const $pcs = $(this);
          const cutVal = parseFloat($pcs.closest('tr').find('.cut-length').val()) || 0;
          const pcsVal = parseInt($pcs.val(), 10) || 0;
          if (cutVal > 0 && pcsVal < 1) {
            $pcs.addClass('error');
            $('#formError')
              .text("Please enter at least 1 piece for each specified cut length.")
              .show();
          }
        })
        // Add delegated blur handler for .tap-side
        .on('blur', '.tap-side', function() {
          const $f = $(this);
          let v = parseInt($f.val().replace(/\D/g, ''), 10);
          if (isNaN(v)) v = 0;
          if (v < 0 || v > 2) {
            $f.addClass('error');
            $f.next('.field-error').remove();
            $('<div class="field-error" style="color:#e53935; font-size:0.9rem; margin-top:0.25rem;">')
              .text('Enter 0, 1 or 2 only')
              .insertAfter($f);
            $f.val('');
          } else {
            $f.removeClass('error');
            $f.next('.field-error').remove();
            $f.val(v);
          }
        })
        .on('click', '.reset-row-btn', function() {
          const $row = $(this).closest('tr');
          $row.find('input').val('');
          updateRow($row);
          updateTotals();
        })
        .on('click', '.delete-row-btn', function() {
          $(this).closest('tr').remove();
          updateTotals();
        });

      // Add More Rows button handler
      $addRowBtn.on('click', () => {
        const $new = $(this.createRow());
        $tableBody.append($new);
        debouncedUpdateTotals();
      });

      // Reset All button handler
      $resetAllBtn.on('click', () => {
        const resetHtml = Array(settings.initRows).fill(this.createRow()).join('');
        $tableBody.html(resetHtml);
        debouncedUpdateTotals();
      });
      // Render initial rows according to settings
      const rowsHtml = Array(settings.initRows).fill(this.createRow()).join('');
      $tableBody.html(rowsHtml);
    }
  };
  window.VSlot = VSlot;
})(window.VSlot = window.VSlot || {}, jQuery);

</script>
<script>
$(function() {
  // Initialize SimpleLightbox
  detailLightbox = $('.details-panel .image-grid a').simpleLightbox({
    captions: false,
    nav: true,
    close: true,
    docClose: true,
    enableKeyboard: true,
    showCounter: false
  });

  // Initialize ordering table
  VSlot.table.init();

  // Initialize Ecwid cart and waste-policy toggle
  Ecwid.init();
  $('#readMoreLink').on('click', function(e) {
    e.preventDefault();
    $('#wasteDetails').slideToggle(200);
  });

  // MOBILE CARD LOGIC (steps 1‚Äì3)

  // Helper to update all card headers based on data-index
  function refreshCardHeaders() {
    $('.mobile-order-cards .order-card').each(function(i) {
      const idx = i + 1;
      $(this).attr('data-index', idx);
      $(this).find('thead th').text(`Enter Details of Pc No. ${idx}`);
      // Update input IDs and corresponding labels
      $(this).find('input, select').each(function() {
        // Find the class that starts with card-
        const fieldMatch = this.className.match(/card-[a-z-]+/);
        if (!fieldMatch) return;
        const field = fieldMatch[0]; // e.g. card-cut-length
        const newId = `card${idx}-${field}`;
        $(this).attr('id', newId);
        $(this).prev('label').attr('for', newId);
      });
    });
  }

  // Add another card
  $('#addCardBtn').on('click', function() {
    const $first = $('.mobile-order-cards .order-card').first();
    const $clone = $first.clone(true, true); // copy events
    $clone.appendTo('.mobile-order-cards');
    refreshCardHeaders();
    if (typeof updateMobileTotals === 'function') updateMobileTotals();
  });

  // Remove a card and update the piece count input
  $('.mobile-order-cards').on('click', '.remove-card-btn', function() {
    const $cards = $('.mobile-order-cards .order-card');
    const currentCount = $cards.length;
    // Remove this card
    $(this).closest('.order-card').remove();
    // Update piece count input
    $('#pieceCountInput').val(currentCount - 1);
    refreshCardHeaders();
    if (typeof updateMobileTotals === 'function') updateMobileTotals();
  });

  // Update button handler for piece count
  $('#updatePiecesBtn').on('click', function() {
    const $cardsContainer = $('.order-cards-container');
    const currentCount = $cardsContainer.find('.order-card').length;
    let desiredCount = parseInt($('#pieceCountInput').val(), 10) || 0;
    if (desiredCount < 1) {
      alert('Please enter at least 1 piece.');
      $('#pieceCountInput').val(currentCount);
      return;
    }
    if (desiredCount > currentCount) {
      // Append new cards
      const $first = $cardsContainer.find('.order-card').first();
      for (let i = currentCount + 1; i <= desiredCount; i++) {
        const $clone = $first.clone(true, true);
        // Clear all input values and remove any error UI
        $clone.find('input').each(function() {
          $(this).val('');
          $(this).removeClass('error');
        });
        $clone.find('.field-error').remove();
        $cardsContainer.append($clone);
      }
      refreshCardHeaders();
      if (typeof updateMobileTotals === 'function') updateMobileTotals();
    } else if (desiredCount < currentCount) {
      // Confirm removal
      if (confirm(`You are reducing from ${currentCount} to ${desiredCount} pieces. Any data in removed cards will be lost. Continue?`)) {
        $cardsContainer.find('.order-card').slice(desiredCount).remove();
        refreshCardHeaders();
        if (typeof updateMobileTotals === 'function') updateMobileTotals();
      } else {
        // Revert input
        $('#pieceCountInput').val(currentCount);
      }
    }
  });

  // Field validation: apply red border and show error message below field
  $('.mobile-order-cards').on('input change', 'input, select', function() {
    const $field = $(this);
    const val = $field.val();
    let valid = true;
    // Basic validation rules
    if ($field.is('.card-cut-length')) {
      const num = parseFloat(val);
      valid = !isNaN(num) && num >= 100 && num <= 3000;
    } else if ($field.is('.card-cb-holes')) {
      const num = parseInt(val, 10);
      valid = !isNaN(num) && num >= 0;
    } else if ($field.is('.card-num-pcs')) {
      const num = parseInt(val, 10);
      valid = !isNaN(num) && num >= 1;
    } // taps select always valid

    // Remove existing error message
    $field.removeClass('error');
    $field.next('.field-error').remove();

    if (!valid) {
      // Mark field invalid
      $field.addClass('error');
      // Append error message
      const msg = $field.is('.card-cut-length')
        ? 'Enter length between 100 and 3000'
        : $field.is('.card-num-pcs')
          ? 'Enter at least 1 piece'
          : 'Invalid value';
      $('<div class="field-error" style="color:#e53935; font-size:0.9rem; margin-top:0.25rem;">')
        .text(msg)
        .insertAfter($field);
    }
    updateMobileTotals();
  });

  // Clamp tap-side input on mobile to digits only and enforce 0‚Äì2 range
  $('.mobile-order-cards').on('input', '.card-tap-side', function() {
    let v = parseInt(this.value.replace(/\D/g, ''), 10);
    if (isNaN(v)) v = '';
    else if (v < 0) v = 0;
    else if (v > 2) v = 2;
    this.value = v;
    updateMobileTotals();
  });

  // Validate tap-side on blur: blank ‚Üí 0, enforce 0‚Äì2 range with error UI
  $('.mobile-order-cards').on('blur', '.card-tap-side', function() {
    const $f = $(this);
    let v = parseInt($f.val().replace(/\D/g, ''), 10);
    if (isNaN(v)) v = 0;
    // Remove existing error UI
    $f.removeClass('error');
    $f.next('.field-error').remove();
    if (v < 0 || v > 2) {
      // Invalid: show error
      $f.addClass('error');
      $('<div class="field-error" style="color:#e53935; font-size:0.9rem; margin-top:0.25rem;">')
        .text('Enter 0, 1 or 2 only')
        .insertAfter($f);
      $f.val('');
    } else {
      // Valid: set normalized value
      $f.val(v);
    }
    updateMobileTotals();
  });

  // --- MOBILE AGGREGATE CARD LOGIC ---
  // 1. Define updateMobileTotals function
  function updateMobileTotals() {
    const holesPerSide = selectedExtrusion?.holesPerSide || 0;
    let totalOrderedLength = 0;
    let totalM5Count = 0;
    let totalCBCount = 0;

    $('.order-cards-container .order-card').each(function() {
      const $card = $(this);
      const length = parseFloat($card.find('.card-cut-length').val()) || 0;
      const pcs = parseInt($card.find('.card-num-pcs').val(), 10) || 0;
      const sides = parseInt($card.find('.card-tap-side').val(), 10) || 0;
      const cb = parseInt($card.find('.card-cb-holes').val(), 10) || 0;

      totalOrderedLength += length * pcs;
      totalM5Count += sides * holesPerSide * pcs;
      totalCBCount += cb * pcs;
    });

    // Rounding logic: find next standard length
    let roundedLength = 0;
    if (totalOrderedLength > 0 && selectedExtrusion) {
      roundedLength = config.standardLengths.find(len => len >= totalOrderedLength)
                      || config.standardLengths[config.standardLengths.length - 1];
    }

    const costExtrusions = roundedLength * (selectedExtrusion?.baseCostPerMm || 0);
    const totalM5Cost = totalM5Count * additionalCosts.m5Tapping;
    const totalCBCost = totalCBCount * additionalCosts.counterBore;
    const subtotal = costExtrusions + totalM5Cost + totalCBCost;
    const gst = subtotal * 0.18;
    const grandTotal = subtotal + gst;

    // Update DOM
    $('#mobileTotalOrdered').text(totalOrderedLength.toFixed(0));
    $('#mobileRoundedLength').text(roundedLength.toFixed(0));
    $('#mobileCostExtrusions').text(costExtrusions.toFixed(2));
    $('#mobileTotalM5Count').text(totalM5Count.toFixed(0));
    $('#mobileTotalM5Cost').text(totalM5Cost.toFixed(2));
    $('#mobileTotalCBCount').text(totalCBCount.toFixed(0));
    $('#mobileTotalCBCost').text(totalCBCost.toFixed(2));
    $('#mobileSubtotal').text(subtotal.toFixed(2));
    $('#mobileGST').text(gst.toFixed(2));
    $('#mobileTotal').text(grandTotal.toFixed(2));

    // Enable/disable mobile Add to Cart
    if (roundedLength === 0 || !selectedExtrusion?.inStock) {
      $('#addToCartBtnMobile').prop('disabled', true);
    } else {
      $('#addToCartBtnMobile').prop('disabled', false);
    }
  }

  // 2. Call updateMobileTotals after validation handlers (at end of $(function() {...}))
  updateMobileTotals();

  // Mobile dropdown change: select extrusion and update aggregates
  $('#mobileExtrusionSelect').on('change', function() {
    const $sel = $(this);
    const id = $sel.val();
    if (!id) return;
    const $box = $('.extrusion-box[data-id="' + id + '"]');
    if ($box.length) {
      $box.trigger('click');
    }
    $sel.val(id);
    updateMobileTotals();
  });
});
</script>
<script>
(function(VSlot, $) {
  // Filter module for extrusion selector
  VSlot.filters = {
    items: [],
    selectedFilters: { type: new Set(), series: new Set(), color: new Set() },
    init: function(items) {
      this.items = items;
      this.renderFilterPills();
      $('#clearFiltersBtn').on('click', () => {
        Object.values(this.selectedFilters).forEach(set => set.clear());
        $('.filter-pill').removeClass('selected');
        this.applyFilters();
      });
    },
    renderFilterPills: function() {
      const groups = [
        { field: 'type',   selector: '#typeFilters',   label: 'Type:'   },
        { field: 'series', selector: '#seriesFilters', label: 'Series:' },
        { field: 'color',  selector: '#colorFilters',  label: 'Colour:' }
      ];
      groups.forEach(g => {
        const container = $(g.selector).empty().append(`<strong>${g.label}</strong>`);
        const values = [...new Set(this.items.map(e => e.attributes[g.field]))];
        values.forEach(val => {
          const count = this.items.filter(e => e.attributes[g.field] === val).length;
          const pill = $(`<span class="filter-pill" data-field="${g.field}" data-value="${val}">${val} (${count})</span>`);
          pill.on('click', () => this.toggleFilter(g.field, val, pill));
          container.append(pill);
        });
      });
    },
    toggleFilter: function(field, value, pillEl) {
      const set = this.selectedFilters[field];
      if (set.has(value)) {
        set.delete(value);
        pillEl.removeClass('selected');
      } else {
        set.add(value);
        pillEl.addClass('selected');
      }
      this.applyFilters();
    },
    applyFilters: function() {
      const filtered = this.items.filter(e =>
        (this.selectedFilters.type.size === 0   || this.selectedFilters.type.has(e.attributes.type))   &&
        (this.selectedFilters.series.size === 0 || this.selectedFilters.series.has(e.attributes.series)) &&
        (this.selectedFilters.color.size === 0  || this.selectedFilters.color.has(e.attributes.color))
      );
      populateExtrusionBoxes(filtered);
    }
  };
})(window.VSlot = window.VSlot || {}, jQuery);
</script>
</html>